# 絵文字シーケンス

まず、Unicode の絵文字の仕様自体についての話。

## 用語

- 符号点 (code point): 文字に割当たってる数字
  - 制御文字とか結合文字(他の文字にくっつく前提の装飾)とかがあるので、「人が見て1文字に見えるもの」とはかけ離れてる
  - UTF-32 であれば固定長
  - 通常、U+007B みたいに `U+` の後ろに4桁が5桁の16進数を付けて表現する
    - U+007B なら16進数で7B、10進数で123の符号点の文字で、 { が割当たってる
- 書記素 (grapheme): 人が1文字と認識するであろう単位
  - キャレットの移動、文字の選択・削除などはこの単位で行うべきとされてる
  - 絵文字以外でも「a + ̈  で ä を表示」みたいな仕様がある
  - いくつかのパターンがある
    - Unicode カテゴリーを見て「Letter の後ろに Mark」みたいな判定でいいものの
    - ハングルとかデーヴァナーガリーとかみたいに、パーツを組み合わせて1文字にするタイプの文字体系
    - `\r\n` は不可分
    - 絵文字と絵文字を ZWJ (Zero Width Joiner: ゼロ幅接合子) でつないで1つの絵文字で表示する
- 絵文字シーケンス(emoji sequence): 複数の符号点で1つの絵文字を表示する仕様
  - 書記素の一種
  - 「絵文字シーケンスになりうる」みたいな判定は書記素分割の仕様に組み込まれてて、ある程度機械的に可能
  - それとは別に、「このパターンの絵文字シーケンスはこういう絵柄で表示しろ」という推奨仕様があって、これはテーブルを引く以外に判定方法がない

## 絵文字シーケンス判定

絵文字シーケンスは可変長なので、まずどこで区切られているかを判定しないとダメ。

- [書記素判定](grapheme-breaking.md)

その後、具体的にどういう画像を表示すればいいかは結局テーブルを引くしかない。
「人系絵文字 + 肌色」くらいならまだ「この文字は色違いのバリエーションがあります」フラグだけで済んでいたものの、今はもっと多様なバリエーションあり。

「最低限どの環境でもこのシーケンスに対応することを推奨する」っていう絵文字シーケンスが決まっていて RGI (Recommended for General Interchange)って呼ばれてる。

- [Recommended for General Interchange](rgi.md)

## RGI 絵文字シーケンスの表示

Windows は RGI にない組み合わせでも頑張って肌色を特殊処理してる。例えば、👩🏻‍👩🏿‍👧🏼‍👧🏾 (たぶん、Windows 以外では 👩🏻 👩🏿 👧🏼 👧🏾 の4文字で表示されるはずだけど、Windows ではちゃんと家族絵文字1文字になる)とかは符号点を並べると 1F469 1F3FB 200D 1F469 1F3FF 200D 1F467 1F3FC 200D 1F467 1F3FE になってる。

OS のテキストレンダリングのレベルでならこういう対応もできるものの、絵文字の自前処理が必要になったときにそこまでできることはまずない。
大体は RGI 絵文字シーケンス1個1個に画像を用意して、その画像に置き換えて表示することに。
Twitter とか Facebook とかが自前の絵文字を表示する際にはそんな感じのことをしてるはず。

RGI に入っている絵文字シーケンスは Unicode 13.0 時点で3300文字だし、
バージョンアップの際に追加される数も最近は 数十個/年 程度に落ち着いてる。
当面の余裕を見るにしても4・5000文字くらいを想定しておけばたぶん大丈夫。

このくらいなら[符号点をそのまま(ハイフン区切りとかで)画像ファイル名](https://github.com/iamcal/emoji-data/tree/master/img-twitter-64)にしたり、
[愚直に `string` キーのリスト](https://github.com/iamcal/emoji-data/blob/master/emoji.json)にしたりでもなんとかなる。

処理の都合上、`string` で閉じて(`string` 引数で渡して `string` 戻り値を返す)処理したいこともあるけど、4・5000文字なら U+E000～F8FF の[外字領域](http://www.asahi-net.or.jp/~ax2s-kmtn/ref/unicode/private.html)(6400文字)に置換とかで処理できそう。
