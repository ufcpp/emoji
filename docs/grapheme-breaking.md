# 書記素判定

絵文字の判定は最終的には「テーブルを引いて一致する文字列があるかどうか」で判定するしかないものの、
テーブルを引くにあたってまずは「絵文字の区切り」を判別しないといけない。

絵文字シーケンスの区切りは書記素分割の仕様の一部に組み込まれてる。

## 書記素分割の仕様

「絵文字シーケンスになっているかどうか」は書記素に関する仕様の一部に含まれていて、
以下のページに詳細が書かれてる。

- [Unicode® Standard Annex #29: Unicode Text Segmentation](https://unicode.org/reports/tr29/)
  - 略して UAX#29 とか UAX29 とか言う
  - 書記素に関する話は「[Grapheme Cluster Boundaries](https://unicode.org/reports/tr29/#Grapheme_Cluster_Boundaries)」

Letter + Mark とかハングルとかデーヴァナーガリーとかを含む仕様なので、
絵文字だけに絞ると以下の2条件だけ調べればいいはず。

```regex
Extended_Pictographic (Extend* ZWJ Extended_Pictographic)* Extend*
RI RI
```

これ以外は「絵文字シーケンスの間にアクセント記号が挟まる」みたいな変な文字列のはずなので、さすがに対処不要。

あと RI (Region Indicator)の方はちょっと特殊仕様なので別処理した方がいい。
ここでは、Extended_Pictographic、Extend、ZWJ の3つについて説明。

## Extended_Pictographic

ZWJ (前述)とか Extend (後述)とかみたいな拡張仕様的なものを除いた基本的な絵文字のことを Extended_Pictographic という名前で分類してる。

pictograph とか pictogram って単語は象形文字とか絵文字という意味で、
emoji とほぼ同義語だったりする。
広い意味では漢字とかエジプトヒエログリフも pictgraph だからか、絵文字判定では Extended_Pictographic って呼び名になってる。

Unicode の仕様上の Extended_Pictographic は [UCD の emoji-data.txt](https://www.unicode.org/Public/UCD/latest/ucd/emoji/emoji-data.txt) で定義されていて、正確に判定するならこれを元にテーブル化が必要。

ただ、大体分布してる場所が決まっているので、概ね以下の3パターンだけ調べればいい。
(大は小を兼ねる判定になるけども、どの道、最終的にはテーブルを引くことになるので、書記素分割時には大が小を兼ねてて問題ない。)

- U+00A9 (©、copyright) か U+00AE (®、registerd)
- U+203C～3300 の範囲
- U+1F000 台

(正確には、 Keycap っていう `a` とか `*` とかみたいな ASCII 文字から始まる変な絵文字シーケンスもあるけど、こいつだけ特殊なパターンになってるので、RI と同じく別処理した方がいいと思う。)

U+203C～3300 の辺りにあるのは Shift_JIS の時代からある記号で、
日本の放送字幕とか印刷所の外字とかに由来してる。

U+1F000 台は元々記号のために予約されてる領域で、
Unicode にキャリア絵文字を追加しようという話になったときに大半の文字をここに入れた。
Shift_JIS 由来の記号と統合できるものは統合してしまったらしく、一部の絵文字は U+203C～3300 に入った。

## Extend

Extend はまんま「他の文字を拡張する文字」みたいな意味。
Letter (a とか) に対する Mark ( ̈  とか)みたいなもの。
実際、UAX29 にある Extend の大部分は Mark。

ただ、大部分は絵文字に無関係で、
絵文字シーケンスに限って言うと、以下の2つだけ調べればいい。

- U+FE0F: 異体字セレクター16 (variation selector-16)
- U+1F3FB～1F3FF: 肌色選択修飾子(emoji modifier Fitzpatrick、skin tone)

異体字セレクターは、「白黒のアウトラインで表示するか、カラーの画像で表示するか」を選択するために使う。
U+FE0E (異体字セレクター15)がついていたら白黒、U+FE0F がついていたらカラー。
元からあった記号とキャリア絵文字を統合してしまったけども、
結局、これまで通り白黒の記号で表示するか、キャリア絵文字としてカラー表示するかを選びたいという話になって追加された仕様。

肌色選択は人系絵文字に付けて肌の色を変えるのに使う。
元々絵文字に人種的な概念を持ち込むつもりはなかったものの、カラー化してしまったことで「白っぽい肌色で描かれることが多いのは差別的だ」という話になってしまってしょうがなく増えた仕様。

「多様性配慮」系の仕様の中では肌色選択だけが Extend 扱い(Extended_Pictographic の直後にくっついて修飾)になってる。
後々、「髪型への配慮」とか「性別への配慮」とかの仕様も増えたものの、
この辺りの追加仕様は ZWJ を挟むことになってて、次節の ZWJ 絵文字シーケンス扱いできる。

## ZWJ

ZWJ はゼロ幅接合子(Zero Width Joiner)の略で、符号点 U+200D の文字のこと。
「絵文字と絵文字を ZWJ でつないで1つの絵文字として表示する」っていう仕様に使う。
こういう絵文字シーケンスを特に「ZWJ 絵文字シーケンス」(ZWJ emoji sequence)って言う。

ちなみに、つないだ結果を認識できない場合、ZWJ を除いた状態の複数の絵文字で表示すればいい。
例えば Unicode 12.0 で追加された盲導犬🐕‍🦺絵文字は U+1F415、U+200D、U+1F9BA の3文字で定義されていて、
これを Unicod 11.0 までしか対応していない環境に持っていくと U+1F415 (🐕、犬) と U+1F9BA (🦺、安全ベスト) の2文字で表示される。

